name: Run clang-format
description: Runs clang-format and checks for any changes introduced by it
inputs:
  failCondition:
    description: Controls whether failed checks also fail the workflow run
    required: false
    default: never
  workingDirectory:
    description: Working directory for checks
    required: false
    default: ${{ github.workspace }}
runs:
  using: composite
  steps:
    - name: Check Runner Operating System ðŸƒâ€â™‚ï¸
      name: Run clang-format
      description: Runs clang-format and checks for any changes introduced by it
      inputs:
        failCondition:
          description: Controls whether failed checks also fail the workflow run
          required: false
          default: never
        workingDirectory:
          description: Working directory for checks
          required: false
          default: ${{ github.workspace }}
      runs:
        using: composite
        steps:
          - name: Check Runner Operating System ðŸƒâ€â™‚ï¸
            if: runner.os == 'Windows'
            shell: bash
            run: |
              : Check Runner Operating System ðŸƒâ€â™‚ï¸
              echo "::notice::run-clang-format action requires a macOS-based or Linux-based runner."
              exit 2

          - name: Check for Changed Files âœ…
            uses: ./.github/actions/check-changes
            id: checks
            with:
              checkGlob: "'*.c' '*.h' '*.cpp' '*.hpp' '*.m' '*.mm'"
              diffFilter: 'ACM'

          - name: Install Dependencies ðŸ›ï¸
            if: runner.os == 'Linux' && fromJSON(steps.checks.outputs.hasChangedFiles)
            shell: bash
            run: |
              : Install Dependencies ðŸ›ï¸
              echo ::group::Install Dependencies
              eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
              echo "/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH
              brew install --quiet zsh
              echo ::endgroup::

          - name: Run clang-format ðŸ‰
            if: fromJSON(steps.checks.outputs.hasChangedFiles)
            id: result
            shell: zsh --no-rcs --errexit --pipefail {0}
            working-directory: ${{ inputs.workingDirectory }}
            env:
              CHANGED_FILES: ${{ steps.checks.outputs.changedFiles }}
            run: |
              : Run clang-format ðŸ‰
              if (( ${+RUNNER_DEBUG} )) setopt XTRACE

              print ::group::Install clang-format
              # Ensure Homebrew environment is loaded and install the latest clang-format
              eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
              brew install --quiet clang-format
              print ::endgroup::

              print ::group::Run clang-format
              # Ensure Homebrew clang-format is in PATH before system clang-format
              # Composite actions may not inherit $GITHUB_PATH, so set PATH explicitly here.
              export PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:${PATH}"

              # Diagnostics to help debug CI runner environment
              print "Diagnostics: which clang-format -> $(which clang-format)"
              print "Diagnostics: clang-format --version -> $(clang-format --version)"

              local -a changes=(${(s:,:)CHANGED_FILES//[\[\]\'\"]/})
              ./build-aux/run-clang-format --fail-${{ inputs.failCondition }} --check ${changes}
              print ::endgroup::
